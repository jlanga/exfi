#!/usr/bin/env python3

import argparse

import logging

from os.path import \
    isfile, \
    abspath

from exfi import __version__
from exfi.io.gfa1_to_gapped_transcripts import \
    gfa1_to_gapped_transcripts





parser = argparse.ArgumentParser(
    usage='gfa1_to_gapped_transcript -i splice_graph.gfa -o '
        'gapped_transcripts.fa',
    description='Compose the transcriptome as a set of exons separated with '
        'gaps',
    epilog='Jorge Langa. Send issues and pull requests to github.com/jlanga/'
           'exfi',
)

parser.add_argument(
    '--version',
    action='version',
    version='%(prog)s {version}'.format(
        version=__version__
    )
)

parser.add_argument(
    '--input-gfa',
    '-i',
    type=str,
    required=True,
    help='Input splice graph in GFA1 format (the results from build_splicegraph)',
    dest='gfa1',
    metavar='FILE'
)

parser.add_argument(
    '--output-fasta',
    '-o',
    type=str,
    required=True,
    help='Path to output fasta file (the gapped transcripts)',
    dest="fasta",
    metavar="FILE"
)

parser.add_argument(
    '--number-of-ns',
    '-n',
    type=int,
    required=False,
    help='Put this number of N between exons [100]',
    dest="number_of_ns",
    metavar="INT",
    default=100
)

parser.add_argument(
    '--soft-mask-overlaps',
    '-s',
    action='store_true',
    required=False,
    help='Mask overlaps as lowercase nucleotides [False]',
    dest="soft_mask_overlaps",
    default=False
)

parser.add_argument(
    '--hard-mask-overlaps',
    '-m',
    action='store_true',
    required=False,
    help='Mask overlaps as Ns [False]',
    dest="hard_mask_overlaps",
    default=False
)

parser.add_argument(
    "-v", "--verbose",
    action="store_true",
    dest="verbose",
    help="Increase output verbosity"
)


if __name__ == "__main__":

    # Parse
    args = vars(parser.parse_args())
    args["gfa1"] = abspath(args["gfa1"])
    args["fasta"] = abspath(args["fasta"])

    # Set up logger
    if args["verbose"]:
        logging.basicConfig(level=logging.INFO, format='%(asctime)s\t%(message)s')
    else:
        logging.basicConfig(level=logging.CRITICAL, format='%(asctime)s %(message)s')

    masking = "none"
    if args["soft_mask_overlaps"] == True:
        masking = "soft"
    if args["hard_mask_overlaps"] == True:
        masking = "hard"

    gfa1_to_gapped_transcripts(
        gfa_in=args["gfa1"],
        fasta_out=args["fasta"],
        number_of_ns=args["number_of_ns"],
        masking=masking
    )
