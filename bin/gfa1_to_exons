#!/usr/bin/env python3

import argparse

import logging

from os.path import \
    isfile, \
    abspath

from exfi import __version__

from exfi.io.gfa1_to_exons import \
    gfa1_to_exons

parser = argparse.ArgumentParser(
    usage='gfa_to_exons -i splice_graph.gfa -o exons.fa',
    description='Extract the exons from a splice graph in GFA format. '
        'Optionally mask overlaps between consecutive exons',
    epilog='Jorge Langa. Send issues and pull requests to github.com/jlanga/'
           'exfi',
)

parser.add_argument(
    '--version',
    action='version',
    version='%(prog)s {version}'.format(
        version=__version__
    )
)

parser.add_argument(
    '--input-gfa',
    '-i',
    type=str,
    required=True,
    help='Input splice graph in GFA1 format (the results from build_splicegraph)',
    dest='gfa1',
    metavar='FILE'
)

parser.add_argument(
    '--output-fasta',
    '-o',
    type=str,
    required=True,
    help='Path to output fasta file (the exons)',
    dest="fasta",
    metavar="FILE"
)

parser.add_argument(
    '--soft-mask-overlaps',
    '-s',
    action='store_true',
    required=False,
    help='Mask overlaps as lowercase nucleotides [False]',
    dest="soft_mask_overlaps",
    default=False
)

parser.add_argument(
    '--hard-mask-overlaps',
    '-m',
    action='store_true',
    required=False,
    help='Mask overlaps as Ns [False]',
    dest="hard_mask_overlaps",
    default=False
)

parser.add_argument(
    "-v", "--verbose",
    action="store_true",
    dest="verbose",
    help="Increase output verbosity"
)

parser.add_argument(
    "-d", "--debug",
    action="store_true",
    dest="debug",
    help="Log everything!"
)

args = parser.parse_args()

if __name__ == "__main__":

    # Parse
    args = vars(parser.parse_args())
    args["gfa1"] = abspath(args["gfa1"])
    args["fasta"] = abspath(args["fasta"])

    # Set up logger
    logger = logging.getLogger()
    logging.basicConfig(format='%(asctime)s\t%(module)s\t%(message)s', level=logging.ERROR)
    if args["verbose"]:
        logger.setLevel(logging.INFO)
    if args["debug"]:
        logger.setLevel(logging.DEBUG)

    masking = "none"
    if args["soft_mask_overlaps"] == True:
        masking = "soft"
    if args["hard_mask_overlaps"] == True:
        masking = "hard"

    gfa1_to_exons(
        gfa_in_fn=args["gfa1"],
        fasta_out_fn=args["fasta"],
        masking=masking
    )

    logging.info("Done!")
